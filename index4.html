<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lottery App (DB + Generator)</title>
  <style>
    :root { color-scheme: light; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 16px; background:#fafafa; }
    h1 { font-size: 20px; margin: 0 0 6px; }
    h2 { font-size: 16px; margin: 0 0 8px; }
    .small { color:#555; font-size: 13px; line-height: 1.35; }
    .ok { color: #0a7; font-weight: 700; }
    .err { color: #c00; font-weight: 700; }

    .topbar { display:flex; justify-content:space-between; align-items:flex-start; gap:12px; margin-bottom: 10px; }
    .today { text-align:right; }
    .pill { display:inline-block; padding: 4px 10px; border-radius: 999px; background:#f1f1f1; border:1px solid #e5e5e5; font-weight:700; font-size:12px; }

    .tabs { display:flex; gap:10px; margin: 10px 0 14px; }
    .tabbtn {
      flex:1; padding: 10px; border-radius: 12px; border:1px solid #ddd; background:#fff;
      font-weight: 800; font-size: 14px;
    }
    .tabbtn.active { background:#111; color:#fff; border-color:#111; }

    .card { background:#fff; border: 1px solid #e5e5e5; border-radius: 14px; padding: 12px; margin: 12px 0; box-shadow: 0 1px 4px rgba(0,0,0,.06); }
    label { display:block; font-weight: 700; margin-top: 10px; }
    select, input, textarea, button {
      width: 100%; padding: 10px; font-size: 16px; margin-top: 6px;
      border-radius: 12px; border:1px solid #ddd; background:#fff;
    }
    textarea { height: 110px; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
    button { border: 0; background:#111; color:#fff; font-weight: 800; }
    button.secondary { background:#555; }
    button.danger { background:#b00020; }
    button:disabled { background:#999; }

    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .btnRow { display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .btnRow button { flex: 1; min-width: 160px; }

    .numbers { font-size: 20px; font-weight: 900; padding: 12px; border: 1px dashed #999; border-radius: 14px; text-align:center; background:#fff; }
    .mutedBox { background:#fcfcfc; border:1px solid #eee; border-radius: 12px; padding:10px; }

    .hide { display:none; }
  </style>
</head>
<body>
  <div class="topbar">
    <div>
      <h1>Lottery App</h1>
      <div class="small">
        Required CSV: <code>game,draw_date,n1,n2,n3,n4,n5,bonus</code><br/>
        game: <code>powerball</code> or <code>ohio_lucky_for_life</code>
      </div>
    </div>
    <div class="today">
      <div class="pill">Today</div>
      <div id="todayText" style="font-weight:900;font-size:14px;margin-top:6px;"></div>
      <div class="small" id="todayISO"></div>
    </div>
  </div>

  <div class="tabs">
    <button class="tabbtn active" id="tabDb">Database</button>
    <button class="tabbtn" id="tabGen">Generator</button>
  </div>

  <!-- ================== DATABASE TAB ================== -->
  <div id="viewDb">
    <div class="card">
      <h2>Saved database</h2>
      <div id="savedStatus" class="small"></div>

      <div class="btnRow">
        <button class="secondary" id="downloadBtn" disabled>Download Backup CSV</button>
        <button class="danger" id="clearBtn" disabled>Clear Saved DB</button>
      </div>

      <div id="summary" class="small" style="margin-top:8px;"></div>
    </div>

    <div class="card">
      <h2>Import CSV (one time)</h2>
      <input id="fileInput" type="file" accept=".csv,text/csv" />
      <div id="loadStatus" class="small" style="margin-top:8px;"></div>

      <div class="mutedBox" style="margin-top:10px;">
        <label>Or paste CSV text:</label>
        <textarea id="csvText" placeholder="Paste CSV here..."></textarea>
        <button class="secondary" id="usePastedBtn">Import & Save Pasted CSV</button>
      </div>
    </div>

    <div class="card">
      <h2>Add a new draw (date picker + dropdowns)</h2>

      <label>Game</label>
      <select id="gameSelect">
        <option value="powerball">powerball</option>
        <option value="ohio_lucky_for_life">ohio_lucky_for_life</option>
      </select>

      <label>Draw Date</label>
      <input id="drawDate" type="date" />

      <div class="row">
        <div><label>n1</label><select id="n1"></select></div>
        <div><label>n2</label><select id="n2"></select></div>
        <div><label>n3</label><select id="n3"></select></div>
        <div><label>n4</label><select id="n4"></select></div>
        <div><label>n5</label><select id="n5"></select></div>
        <div><label id="bonusLabel">bonus</label><select id="bonus"></select></div>
      </div>

      <button id="addBtn" disabled>Add Draw to Database</button>
      <div id="addStatus" class="small" style="margin-top:8px;"></div>
    </div>
  </div>

  <!-- ================== GENERATOR TAB ================== -->
  <div id="viewGen" class="hide">
    <div class="card">
      <h2>Number Generator</h2>

      <label>Game</label>
      <select id="genGame">
        <option value="powerball">powerball</option>
        <option value="ohio_lucky_for_life">ohio_lucky_for_life</option>
      </select>

      <div class="row">
        <div>
          <label>How many sets?</label>
          <input id="genCount" type="number" min="1" max="50" value="5" />
        </div>
        <div>
          <label>Avoid exact matches from last N draws</label>
          <input id="avoidLastN" type="number" min="0" max="500" value="0" />
        </div>
      </div>

      <button id="genBtn">Generate</button>

      <div id="genOut" style="margin-top:10px; display:grid; gap:10px;"></div>
      <div id="genStatus" class="small" style="margin-top:8px;"></div>
    </div>
  </div>

<script>
  const REQUIRED_HEADER = "game,draw_date,n1,n2,n3,n4,n5,bonus";
  const STORAGE_KEY = "LOTTERY_DRAW_DB_CSV_V1";

  const RULES = {
    powerball: { mainMin: 1, mainMax: 69, bonusMin: 1, bonusMax: 26, bonusLabel: "Powerball" },
    ohio_lucky_for_life: { mainMin: 1, mainMax: 48, bonusMin: 1, bonusMax: 18, bonusLabel: "Lucky Ball" }
  };

  let dbLines = [];
  const el = (id) => document.getElementById(id);

  function setStatus(target, msg, ok=true) {
    target.innerHTML = msg ? (ok ? `<span class="ok">${msg}</span>` : `<span class="err">${msg}</span>`) : "";
  }

  function isISODate(s) {
    if (!/^\d{4}-\d{2}-\d{2}$/.test(s)) return false;
    const d = new Date(s + "T00:00:00");
    return !Number.isNaN(d.getTime());
  }

  function parseCsv(text) {
    const trimmed = (text || "").trim();
    if (!trimmed) throw new Error("CSV is empty.");
    const lines = trimmed.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
    if (!lines.length) throw new Error("CSV has no lines.");
    if (lines[0] !== REQUIRED_HEADER) throw new Error("CSV columns must be: " + REQUIRED_HEADER);

    for (let i=1; i<lines.length; i++) {
      const parts = lines[i].split(",").map(x=>x.trim());
      if (parts.length !== 8) throw new Error(`Bad row at line ${i+1}: expected 8 columns.`);
      const [game, draw_date] = parts;
      if (game !== "powerball" && game !== "ohio_lucky_for_life") throw new Error(`Bad game at line ${i+1}: ${game}`);
      if (!isISODate(draw_date)) throw new Error(`Bad draw_date at line ${i+1}: ${draw_date}`);
      const nums = parts.slice(2).map(Number);
      if (nums.some(x => !Number.isFinite(x))) throw new Error(`Non-numeric value at line ${i+1}`);
    }
    return lines;
  }

  function saveToDevice() {
    localStorage.setItem(STORAGE_KEY, dbLines.join("\n"));
    refreshTopStatus();
  }

  function loadFromDevice() {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (!saved) return false;
    dbLines = parseCsv(saved);
    return true;
  }

  function range(min, max) { return Array.from({length:max-min+1}, (_,i)=>i+min); }

  function fillSelect(sel, options, def) {
    sel.innerHTML = "";
    for (const v of options) {
      const opt = document.createElement("option");
      opt.value = String(v);
      opt.textContent = String(v);
      sel.appendChild(opt);
    }
    sel.value = String(def);
  }

  function refreshAddDropdowns() {
    const game = el("gameSelect").value;
    const r = RULES[game];
    el("bonusLabel").textContent = "bonus (" + r.bonusLabel + ")";
    const mainOpts = range(r.mainMin, r.mainMax);
    fillSelect(el("n1"), mainOpts, r.mainMin);
    fillSelect(el("n2"), mainOpts, r.mainMin+1);
    fillSelect(el("n3"), mainOpts, r.mainMin+2);
    fillSelect(el("n4"), mainOpts, r.mainMin+3);
    fillSelect(el("n5"), mainOpts, r.mainMin+4);
    const bonusOpts = range(r.bonusMin, r.bonusMax);
    fillSelect(el("bonus"), bonusOpts, r.bonusMin);
  }

  function hasDuplicate(game, draw_date) {
    for (let i=1; i<dbLines.length; i++) {
      const parts = dbLines[i].split(",").map(x=>x.trim());
      if (parts[0] === game && parts[1] === draw_date) return true;
    }
    return false;
  }

  function summarize() {
    if (!dbLines.length) { el("summary").textContent = ""; return; }
    let pb = 0, lfl = 0;
    for (let i=1;i<dbLines.length;i++) {
      const g = dbLines[i].split(",")[0].trim();
      if (g === "powerball") pb++;
      if (g === "ohio_lucky_for_life") lfl++;
    }
    el("summary").textContent = `Rows saved: ${dbLines.length-1} (powerball: ${pb}, ohio_lucky_for_life: ${lfl})`;
  }

  function refreshTopStatus() {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
      setStatus(el("savedStatus"), "Saved DB found on this device.");
      el("downloadBtn").disabled = false;
      el("clearBtn").disabled = false;
      el("addBtn").disabled = false;
      summarize();
    } else {
      setStatus(el("savedStatus"), "No saved DB yet. Import your CSV below.", false);
      el("downloadBtn").disabled = true;
      el("clearBtn").disabled = true;
      el("addBtn").disabled = true;
      el("summary").textContent = "";
    }
  }

  // ---- Tabs ----
  function showTab(which) {
    const db = el("viewDb"), gen = el("viewGen");
    const b1 = el("tabDb"), b2 = el("tabGen");
    if (which === "db") {
      db.classList.remove("hide"); gen.classList.add("hide");
      b1.classList.add("active"); b2.classList.remove("active");
    } else {
      gen.classList.remove("hide"); db.classList.add("hide");
      b2.classList.add("active"); b1.classList.remove("active");
    }
  }
  el("tabDb").addEventListener("click", () => showTab("db"));
  el("tabGen").addEventListener("click", () => showTab("gen"));

  // ---- Import ----
  el("fileInput").addEventListener("change", async (e) => {
    const f = e.target.files?.[0];
    if (!f) return;
    const text = await f.text();
    try { dbLines = parseCsv(text); saveToDevice(); setStatus(el("loadStatus"), "CSV imported and saved."); }
    catch (err) { setStatus(el("loadStatus"), err.message || "Failed to import CSV", false); }
  });

  el("usePastedBtn").addEventListener("click", () => {
    try { dbLines = parseCsv(el("csvText").value); saveToDevice(); setStatus(el("loadStatus"), "Pasted CSV imported and saved."); }
    catch (err) { setStatus(el("loadStatus"), err.message || "Failed to import CSV", false); }
  });

  // ---- Add draw ----
  el("addBtn").addEventListener("click", () => {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (!saved) { setStatus(el("addStatus"), "Import CSV first.", false); return; }
    try { dbLines = parseCsv(saved); } catch { setStatus(el("addStatus"), "Saved DB is corrupted. Re-import.", false); return; }

    const game = el("gameSelect").value;
    const draw_date = el("drawDate").value; // from date picker (YYYY-MM-DD)
    const r = RULES[game];

    const n1=+el("n1").value, n2=+el("n2").value, n3=+el("n3").value, n4=+el("n4").value, n5=+el("n5").value, bonus=+el("bonus").value;
    const mains=[n1,n2,n3,n4,n5];

    if (!isISODate(draw_date)) { setStatus(el("addStatus"), "Pick a draw date.", false); return; }
    if (new Set(mains).size !== 5) { setStatus(el("addStatus"), "n1..n5 must be unique.", false); return; }

    const inRange = (x,min,max)=>Number.isFinite(x)&&x>=min&&x<=max;
    if (!mains.every(x=>inRange(x,r.mainMin,r.mainMax))) { setStatus(el("addStatus"), `Main numbers must be ${r.mainMin}-${r.mainMax}.`, false); return; }
    if (!inRange(bonus,r.bonusMin,r.bonusMax)) { setStatus(el("addStatus"), `Bonus must be ${r.bonusMin}-${r.bonusMax}.`, false); return; }

    if (hasDuplicate(game, draw_date)) { setStatus(el("addStatus"), "That game + draw_date already exists.", false); return; }

    dbLines.push(`${game},${draw_date},${n1},${n2},${n3},${n4},${n5},${bonus}`);
    saveToDevice();
    setStatus(el("addStatus"), "Added and saved (last line = last drawn).");
  });

  // ---- Generator ----
  function pickUnique(min, max, count) {
    const set = new Set();
    while (set.size < count) set.add(Math.floor(Math.random()*(max-min+1))+min);
    return Array.from(set).sort((a,b)=>a-b);
  }

  function csvRowsForGame(game) {
    // optional; used to avoid last N exact matches
    const rows = [];
    for (let i=1;i<dbLines.length;i++) {
      const [g, d, n1,n2,n3,n4,n5,bonus] = dbLines[i].split(",").map(x=>x.trim());
      if (g !== game) continue;
      rows.push({ d, n1:+n1,n2:+n2,n3:+n3,n4:+n4,n5:+n5,bonus:+bonus });
    }
    return rows;
  }
  function key(draw){ return `${draw.n1}-${draw.n2}-${draw.n3}-${draw.n4}-${draw.n5}|${draw.bonus}`; }

  el("genBtn").addEventListener("click", () => {
    el("genOut").innerHTML = "";
    setStatus(el("genStatus"), "");

    const game = el("genGame").value;
    const r = RULES[game];
    const count = Math.max(1, Math.min(50, Number(el("genCount").value) || 1));
    const avoidLastN = Math.max(0, Number(el("avoidLastN").value) || 0);

    // Load DB if present
    const saved = localStorage.getItem(STORAGE_KEY);
    let avoid = new Set();
    if (saved) {
      try {
        dbLines = parseCsv(saved);
        if (avoidLastN > 0) {
          const rows = csvRowsForGame(game);
          const last = rows.slice(-avoidLastN);
          last.forEach(x => avoid.add(key(x)));
        }
      } catch {}
    }

    let tries = 0, maxTries = 6000;
    for (let i=0;i<count;i++) {
      let made = null;
      while (tries < maxTries) {
        tries++;
        const mains = pickUnique(r.mainMin, r.mainMax, 5);
        const bonus = Math.floor(Math.random()*(r.bonusMax-r.bonusMin+1))+r.bonusMin;
        const candidate = { n1:mains[0],n2:mains[1],n3:mains[2],n4:mains[3],n5:mains[4],bonus };
        if (avoid.size && avoid.has(key(candidate))) continue;
        made = candidate; break;
      }
      if (!made) { setStatus(el("genStatus"), "Could not generate. Set avoidLastN to 0.", false); break; }

      const box = document.createElement("div");
      box.className = "numbers";
      box.textContent = `${made.n1}  ${made.n2}  ${made.n3}  ${made.n4}  ${made.n5}   +${made.bonus}`;
      el("genOut").appendChild(box);
    }

    setStatus(el("genStatus"), `Generated ${count} set(s).` + (avoid.size ? ` Avoided last ${avoidLastN}.` : ""));
  });

  // ---- Download / Clear ----
  el("downloadBtn").addEventListener("click", () => {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (!saved) return;
    const blob = new Blob([saved], { type: "text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "draws_saved_backup.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  el("clearBtn").addEventListener("click", () => {
    if (!confirm("Delete saved database from this device?")) return;
    localStorage.removeItem(STORAGE_KEY);
    dbLines = [];
    refreshTopStatus();
    setStatus(el("loadStatus"), "Cleared. Import again to start over.");
    setStatus(el("addStatus"), "");
    setStatus(el("genStatus"), "");
    el("genOut").innerHTML = "";
  });

  // ---- Init today date + default draw date ----
  const now = new Date();
  const iso = now.toISOString().slice(0,10);
  el("todayISO").textContent = iso;
  el("todayText").textContent = now.toLocaleDateString(undefined, { weekday:"long", year:"numeric", month:"short", day:"numeric" });
  el("drawDate").value = iso; // default picker to today

  // Init dropdowns
  el("gameSelect").addEventListener("change", refreshAddDropdowns);
  refreshAddDropdowns();

  // Auto-load saved DB
  try {
    loadFromDevice();
    refreshTopStatus();
    setStatus(el("loadStatus"), "Ready.");
  } catch {
    localStorage.removeItem(STORAGE_KEY);
    dbLines = [];
    refreshTopStatus();
    setStatus(el("savedStatus"), "Saved DB was invalid and was cleared. Please import again.", false);
  }
</script>
</body>
</html>
